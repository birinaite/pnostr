<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carregando Áudio</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        #loading {
            font-size: 18px;
            color: #333;
        }
        #eventContent, #audioPlayerContainer {
            display: none;
        }
        #audioPlayerContainer {
            margin-top: 20px;
        }
        button {
            margin: 10px;
            padding: 10px;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div>
        <button onclick="startProcess('2273f05320f2e4112d96487f0489afcf38ee4b53a2d4899fc601d581537a9577')">Risada do Dov</button>
        <button onclick="startProcess('93d127b38e3644ec66577d2645e369f90c6327bdb5eefe77badd23d650240c71')">Bom dia Guerreiros</button>
        <button onclick="startProcess('535a4ee07e85c105110237ad1d7576d7f9b9b2b34c76af6b0ecc3fe9ae70323b')">Bruce Its Time!</button>
        <button onclick="startProcess('eb8a2ed11883f00e5cf3500becd22d6ee43dbb13097f6cbfe03319c7588848d9')">You got a beard!</button>
        <button onclick="startProcess('7d06b01fed043623cf13e38bf6eae8bda0aeaba2d338be412b8e61d5347c3a8d')">Frankie Bitcoin</button>
        <button onclick="startProcess('0926eebe6996278555719d1489201bd360ab42a0aae6905f4a80cb3b191b13c5')">Saylor no 2nd best Bitcoin</button>
    </div>
    <div id="loading"></div>
    <div id="eventContent"></div>
    <div id="audioPlayerContainer">
        <audio id="audioPlayer" controls>
            Seu navegador não suporta o elemento de áudio.
        </audio>
    </div>

    <script>
        const relayUrl = 'wss://relay.primal.net'; 

        let eventIdsHex = [];
        let combinedPartContent = '';  
        let eventsProcessed = 0;   

        const loadingDiv = document.getElementById('loading');
        const eventContentDiv = document.getElementById('eventContent');
        const audioPlayerContainerDiv = document.getElementById('audioPlayerContainer');

        function fetchPostContent(postId) {
            const ws = new WebSocket(relayUrl);
            const subscriptionId = 'sub_' + Date.now();

            ws.onopen = function() {
                const reqMessage = ["REQ", subscriptionId, { "ids": [postId] }];
                ws.send(JSON.stringify(reqMessage));
                loadingDiv.textContent = "Carregando, por favor aguarde...";
            };

            ws.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    if (data[0] === "EVENT" && data[1] === subscriptionId) {
                        const content = data[2].content;
                        eventIdsHex = content.split('|'); // Quebrando o conteúdo do post em um array
                        ws.close(); // Fechar a conexão após receber o conteúdo
                        fetchAudioParts(); // Iniciar a busca dos eventos com os IDs obtidos
                    }
                } catch (error) {
                    loadingDiv.textContent = 'Erro ao processar a mensagem recebida';
                }
            };

            ws.onerror = function(err) {
                loadingDiv.textContent = 'Erro na conexão';
            };

            ws.onclose = function() {
                // Conexão fechada
            };
        }

        function fetchAudioParts() {
            const ws = new WebSocket(relayUrl);
            const subscriptionId = 'sub_' + Date.now();

            ws.onopen = function() {
                eventIdsHex.forEach(eventIdHex => {
                    const reqMessage = ["REQ", subscriptionId, { "ids": [eventIdHex] }];
                    ws.send(JSON.stringify(reqMessage));
                });
            };

            ws.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    if (data[0] === "EVENT" && data[1] === subscriptionId) {
                        const content = JSON.parse(data[2].content);
                        if (content.part) {
                            combinedPartContent += content.part;
                        }
                        eventsProcessed++;
                        if (eventsProcessed === eventIdsHex.length) {
                            createAudioPlayer(combinedPartContent);
                        }
                    }
                } catch (error) {
                    loadingDiv.textContent = 'Erro ao processar a mensagem recebida';
                }
            };

            ws.onerror = function(err) {
                loadingDiv.textContent = 'Erro na conexão';
            };

            ws.onclose = function() {
                // Conexão fechada
            };
        }

        function createAudioPlayer(base64String) {
            const byteCharacters = atob(base64String);
            const byteNumbers = new Array(byteCharacters.length);
            for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i);
            }
            const byteArray = new Uint8Array(byteNumbers);
            const blob = new Blob([byteArray], { type: 'audio/mp3' });
            const blobURL = URL.createObjectURL(blob);
            const audioPlayer = document.getElementById('audioPlayer');
            audioPlayer.src = blobURL;

            loadingDiv.style.display = 'none';
            audioPlayerContainerDiv.style.display = 'block';
            audioPlayer.play();
        }

        function startProcess(postId) {
            loadingDiv.style.display = 'block';
            audioPlayerContainerDiv.style.display = 'none';
            loadingDiv.textContent = 'Carregando...';
            combinedPartContent = '';
            eventsProcessed = 0;
            fetchPostContent(postId);
        }
    </script>
</body>
</html>
